<tr id="row-{{ item.index }}" class="review-row">
    <td class="alexa-text">
        <a href="https://www.instacart.com/store/{{ instacart_store | lower }}/search/{{ item.alexa_text | urlencode }}" target="_blank">{{ item.alexa_text }}</a>
        {% if item.extra_alexa_items %}
        <span class="dedup-extras">
            {% for extra in item.extra_alexa_items %}<span class="dedup-extra-item">{{ extra.text }}</span>
            {% endfor %}
        </span>
        {% endif %}
    </td>
    <td class="product-cell">
        <input type="hidden" name="items[{{ item.index }}][alexa_text]" value="{{ item.alexa_text }}">
        <input type="hidden" name="items[{{ item.index }}][product_name]" value="{{ item.product_name or '' }}" class="hidden-product-name">
        <input type="hidden" name="items[{{ item.index }}][product_url]" value="{{ item.product_url or '' }}" class="hidden-product-url">
        <input type="hidden" name="items[{{ item.index }}][image_url]" value="{{ item.image_url or '' }}" class="hidden-image-url">
        <input type="hidden" name="items[{{ item.index }}][brand]" value="{{ item.brand or '' }}" class="hidden-brand">
        <input type="hidden" name="items[{{ item.index }}][item_id]" value="{{ item.item_id or '' }}" class="hidden-item-id">
        <input type="hidden" name="items[{{ item.index }}][size]" value="{{ item.size or '' }}" class="hidden-size">
        <input type="hidden" name="items[{{ item.index }}][grocery_item_id]" value="{{ item.grocery_item_id or '' }}">
        <input type="hidden" name="items[{{ item.index }}][alexa_item_id]" value="{{ item.alexa_item_id or '' }}">
        <input type="hidden" name="items[{{ item.index }}][skip]" value="" class="hidden-skip">
        <input type="hidden" name="items[{{ item.index }}][extra_alexa_items]"
               value="{{ item.extra_alexa_items | tojson if item.extra_alexa_items else '' }}">

        {% if item.alternatives %}
        {# Alternatives list — preferences first, then search results #}
        {% set has_both = item.alternatives | selectattr('source', 'equalto', 'preference') | list | length > 0 and item.alternatives | selectattr('source', 'equalto', 'search') | list | length > 0 %}
        <div class="product-options">
            {% for alt in item.alternatives %}
            {% if has_both and loop.first and alt.source == 'preference' %}
            <div class="alternatives-divider">Your preferences</div>
            {% endif %}
            {% if has_both and alt.source == 'search' and (loop.first or item.alternatives[loop.index0 - 1].source == 'preference') %}
            <div class="alternatives-divider">Search results</div>
            {% endif %}
            <label class="product-option {% if loop.first %}selected{% endif %}">
                <input
                    type="radio"
                    name="items[{{ item.index }}][selected]"
                    value="{{ loop.index0 }}"
                    {% if loop.first %}checked{% endif %}
                    onchange="selectAlternative({{ item.index }}, this)"
                    data-product-name="{{ alt.product_name }}"
                    data-product-url="{{ alt.product_url or '' }}"
                    data-brand="{{ alt.brand or '' }}"
                    data-price="{{ alt.price or '' }}"
                    data-image-url="{{ alt.image_url or '' }}"
                    data-item-id="{{ alt.item_id or '' }}"
                    data-size="{{ alt.size or '' }}"
                >
                {% if alt.image_url %}<img src="{{ alt.image_url }}" alt="" class="option-thumb">{% endif %}
                <span class="option-details">
                    <strong>{{ alt.product_name }}</strong>
                    {% if alt.brand %}<span class="brand">{{ alt.brand }}</span>{% endif %}
                    {% if alt.price %}<span class="price">{{ alt.price }}</span>{% endif %}
                    {% if alt.size %}<span class="size">{{ alt.size }}</span>{% endif %}
                    {% if alt.product_url %}<a href="{{ alt.product_url }}" target="_blank" class="product-link" onclick="event.stopPropagation()">view</a>{% endif %}
                    {% if not alt.in_stock %}<span class="badge badge-error">Out of stock</span>{% endif %}
                </span>
            </label>
            {% endfor %}
            <label class="product-option skip-option">
                <input
                    type="radio"
                    name="items[{{ item.index }}][selected]"
                    value="skip"
                    onchange="toggleSkip({{ item.index }})"
                >
                <span class="option-details"><strong>Skip this item</strong><span class="brand">Handle manually / buy separately</span></span>
            </label>
        </div>
        {% elif item.product_name %}
        {# Matched item — single product as radio #}
        <div class="product-options">
            <label class="product-option selected">
                <input
                    type="radio"
                    name="items[{{ item.index }}][selected]"
                    value="0"
                    checked
                    onchange="selectAlternative({{ item.index }}, this)"
                    data-product-name="{{ item.product_name }}"
                    data-product-url="{{ item.product_url or '' }}"
                    data-brand="{{ item.brand or '' }}"
                    data-price="{{ item.price or '' }}"
                    data-image-url="{{ item.image_url or '' }}"
                    data-item-id="{{ item.item_id or '' }}"
                    data-size="{{ item.size or '' }}"
                >
                {% if item.image_url %}<img src="{{ item.image_url }}" alt="" class="option-thumb">{% endif %}
                <span class="option-details">
                    <strong>{{ item.product_name }}</strong>
                    {% if item.brand %}<span class="brand">{{ item.brand }}</span>{% endif %}
                    {% if item.price %}<span class="price">{{ item.price }}</span>{% endif %}
                    {% if item.size %}<span class="size">{{ item.size }}</span>{% endif %}
                    {% if item.product_url %}<a href="{{ item.product_url }}" target="_blank" class="product-link" onclick="event.stopPropagation()">view</a>{% endif %}
                </span>
            </label>
            <label class="product-option skip-option">
                <input
                    type="radio"
                    name="items[{{ item.index }}][selected]"
                    value="skip"
                    onchange="toggleSkip({{ item.index }})"
                >
                <span class="option-details"><strong>Skip this item</strong><span class="brand">Handle manually / buy separately</span></span>
            </label>
        </div>
        {% else %}
        {# No match — URL input + skip #}
        <span class="muted">No match found</span>
        <div class="product-options" style="margin-top: 0.375rem;">
            <label class="product-option skip-option">
                <input
                    type="radio"
                    name="items[{{ item.index }}][selected]"
                    value="skip"
                    onchange="toggleSkip({{ item.index }})"
                >
                <span class="option-details"><strong>Skip this item</strong><span class="brand">Handle manually / buy separately</span></span>
            </label>
        </div>
        {% endif %}
        <div class="custom-url-section">
            <details>
                <summary class="btn btn-xs btn-outline">Use custom URL</summary>
                <div class="inline-form">
                    <input type="url" placeholder="Paste Instacart product URL..." style="flex:1" class="custom-url-val-{{ item.index }}">
                    <button type="button" id="fetch-btn-{{ item.index }}" class="btn btn-sm btn-primary" onclick="fetchProductUrl({{ item.index }})">Fetch</button>
                    <span id="url-spinner-{{ item.index }}" class="htmx-indicator">Loading...</span>
                </div>
                <div id="custom-result-{{ item.index }}"></div>
            </details>
        </div>
    </td>
    <td class="qty-cell">
        <input type="number" name="items[{{ item.index }}][quantity]" value="1" min="1" max="99" class="qty-input">
    </td>
    <td class="status">
        <div id="status-{{ item.index }}">
            <span class="badge badge-{{ item.status_class }}" data-original-status="{{ item.status }}" data-original-class="badge-{{ item.status_class }}">{{ item.status }}</span>
        </div>
    </td>
</tr>
