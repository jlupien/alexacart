<div class="card preference-card" id="pref-{{ item.id }}">
    <div class="pref-header">
        <h3><a href="https://www.instacart.com/store/{{ instacart_store | lower }}/search/{{ item.name | urlencode }}" target="_blank">{{ item.name }}</a></h3>
        <button
            class="btn btn-sm btn-danger"
            hx-delete="/preferences/items/{{ item.id }}"
            hx-target="#pref-{{ item.id }}"
            hx-swap="outerHTML"
            hx-confirm="Delete '{{ item.name }}' and all its aliases/products?"
        >Delete</button>
    </div>

    <div class="pref-section">
        <h4>Aliases</h4>
        <div class="alias-list">
            {% for a in item.aliases if a.alias != item.name %}
            <span class="alias-tag">
                {{ a.alias }}
                <button
                    class="alias-remove"
                    hx-delete="/preferences/aliases/{{ a.id }}"
                    hx-target="#pref-{{ item.id }}"
                    hx-swap="outerHTML"
                >&times;</button>
            </span>
            {% endfor %}
        </div>
        <form class="inline-form" hx-post="/preferences/items/{{ item.id }}/aliases" hx-target="#pref-{{ item.id }}" hx-swap="outerHTML" hx-on::after-request="if(event.detail.successful) this.reset()">
            <input type="text" name="alias" placeholder="Add alias..." required>
            <button type="submit" class="btn btn-sm btn-primary">Add</button>
        </form>
    </div>

    <div class="pref-section">
        <h4>Preferred Products</h4>
        {% if item.preferred_products %}
        <ol class="product-rank-list">
            {% for p in item.preferred_products %}
            <li>
                <span class="rank-badge">#{{ p.rank }}</span>
                {% if p.image_url %}<img src="{{ p.image_url }}" alt="" class="product-thumb">{% endif %}
                <span>{{ p.product_name }}</span>
                {% if p.size %}<span class="size">{{ p.size }}</span>{% endif %}
                {% if p.product_url %}<a href="{{ p.product_url }}" target="_blank" class="product-link" title="{{ p.product_url }}">link</a>{% endif %}
                {% if p.brand %}<span class="brand">({{ p.brand }})</span>{% endif %}
                <div class="rank-controls">
                    {% if p.rank > 1 %}
                    <button class="btn btn-xs" hx-post="/preferences/products/{{ p.id }}/move-up" hx-target="#pref-{{ item.id }}" hx-swap="outerHTML">Up</button>
                    {% endif %}
                    <button class="btn btn-xs btn-danger" hx-delete="/preferences/products/{{ p.id }}" hx-target="#pref-{{ item.id }}" hx-swap="outerHTML">Remove</button>
                </div>
            </li>
            {% endfor %}
        </ol>
        {% else %}
        <p class="muted">No preferred products yet.</p>
        {% endif %}
        {% if url_error is defined and url_error %}
        <div class="status-message status-error" style="margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.85rem;">{{ url_error }}</div>
        {% endif %}
        <form class="inline-form" hx-post="/preferences/items/{{ item.id }}/products/from-url" hx-target="#pref-{{ item.id }}" hx-swap="outerHTML" hx-indicator="#url-spinner-{{ item.id }}" hx-disabled-elt="find .btn-primary">
            <input type="url" name="url" placeholder="Paste Instacart product URL..." required style="flex: 1;">
            <button type="submit" class="btn btn-sm btn-primary">Add from URL</button>
            <span id="url-spinner-{{ item.id }}" class="htmx-indicator">Loading...</span>
        </form>
    </div>
</div>
